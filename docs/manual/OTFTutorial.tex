%% !TEX root = manual.tex

\section{Using OTF2}
\label{sec:tutorial:otf}
OTF2 is a general purpose trace format with specialized callbacks for the MPI API. OTF2 traces are generated by programs compiled with ScoreP compiler wrappers. SST/macro 7.0 supports OTF2 trace replay when configured with --enable-otf2=<path-to-OTF2>. OTF2 is a ScoreP dependency, so it is recommended to simply install ScoreP packages.
\subsection{Building ScoreP/OTF2}
\label{subset:otf:build}
\subsubsection{Spack}
\begin{ViFile}
spack install scorep
\end{ViFile}
As of v0.10.0, Spack will build it's own MPI. To use an existing system MPI, modify Spack's package.yaml file.
\subsubsection{Centos 7}
\begin{ViFile}
yum install -y epel
yum install	-y scorep
\end{ViFile}


\subsection{Trace Collection}
\label{subsec:otf:traceCollection}
ScoreP's default collection strategy will include every function call in the trace, making even small programs produce untenably large traces. ScoreP supports collection filters, which can restrict collection at a minimum to MPI and OMP function calls. At the end of the program's runtime, traces from each rank are put in a common directory. This script demonstrates the creation, compilation and running of an MPI program compiled with ScoreP to produce traces:

\begin{ViFile}
#!/bin/bash

# these environment variables are picked up by ScoreP at runtime
export SCOREP_ENABLE_TRACING=true
export SCOREP_TOTAL_MEMORY=1G
export SCOREP_FILTERING_FILE='./scorep.filter'

rm -r bcast.* scorep-*

# Creating the filter file
cat <<EOF > scorep.filter
SCOREP_REGION_NAMES_BEGIN EXCLUDE
*
EOF

# The program to trace
cat <<EOF > bcast.c
/*
 * Broadcasts a message from rank 0
 */

#include "mpi.h"
#include <stdio.h>
#include <unistd.h>

#define SLEEP_SECONDS 1
#define SLEEP() usleep(SLEEP_SECONDS*1000*1000)

int main(int argc, char** argv) {
   int rank, buf;
   int root = 0;
   MPI_Status status;
   MPI_Init(&argc, &argv);
   MPI_Comm_rank(MPI_COMM_WORLD, &rank);

   SLEEP();
   MPI_Bcast(&buf, 1, MPI_INT, root, MPI_COMM_WORLD);

   MPI_Finalize();
   return 0;
}
EOF

# Build the program with ScoreP wrappers
scorep-mpicxx -o bcast.exe bcast.c

# Run the program normally
mpirun -np 2 bcast.exe
\end{ViFile}

To view a plain-text representation of the trace, use the otf2-print tool.
\begin{ViFile}
otf2-print scorep-*/traces.otf2
\end{ViFile}


\subsection{Trace Replay}
\label{subsec:otf:traceReplay}
SST/macro will use a trace replay skeleton for OTF2 in much the same way as it does for dumpi. SST/macro trace replays configured using *.ini files. 
\begin{ViFile}
include debug.ini

app1.otf2_timescale = 1.0

# debugging output
app1.otf2_print_mpi_calls=false
app1.otf2_print_trace_events=false
app1.otf2_print_time_deltas=false
app1.otf2_warn_unknown_callback=false

app1.otf2_metafile = <path-to-trace>/scorep-20170309_1421_27095992608015568/traces.otf2

app1.name = otf2_trace_replay_app
app1.size = 1
\end{ViFile}
